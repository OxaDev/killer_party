<!DOCTYPE html>
<html>
<head>
    <title>Killer Party</title>
    <script>
        async function sendRequest(url, method, data, resultElementId) {
            const resultElement = document.getElementById(resultElementId);
            resultElement.innerHTML = "Processing...";
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // For CSRF protection
                    },
                    body: method === 'POST' ? JSON.stringify(data) : null
                });
                const result = await response.json();
                resultElement.innerHTML = JSON.stringify(result, null, 2);
            } catch (error) {
                resultElement.innerHTML = "An error occurred: " + error.message;
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</head>
<body>
    <h1>Welcome to Killer Party</h1>

    <div>
        <h3>Get Your Target</h3>
        <input type="text" id="gameCodeForDropdown" placeholder="Game Code" />
        <button onclick="loadPlayers()">Load Players</button>
        <select id="playerDropdown">
            <option value="">Select your name</option>
        </select>
        <input type="text" id="playerCode" placeholder="Player Code" />
        <button onclick="getTarget()">Get Your Target</button>
        <pre id="targetResult"></pre>
    </div>
    
    <script>
        async function loadPlayers() {
            const gameCode = document.getElementById('gameCodeForDropdown').value;
            const dropdown = document.getElementById('playerDropdown');
            dropdown.innerHTML = '<option value="">Loading...</option>';
    
            try {
                const response = await fetch(`/get-players/${gameCode}/`);
                const data = await response.json();
                if (data.error) {
                    alert(data.error);
                    return;
                }
    
                dropdown.innerHTML = '<option value="">Select your name</option>';
                data.players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player;
                    option.textContent = player;
                    dropdown.appendChild(option);
                });
            } catch (error) {
                alert("Error loading players: " + error.message);
            }
        }
    
        async function getTarget() {
            const gameCode = document.getElementById('gameCodeForDropdown').value;
            const playerName = document.getElementById('playerDropdown').value;
            const playerCode = document.getElementById('playerCode').value;
    
            if (!playerName) {
                alert("Please select a player.");
                return;
            }
    
            const resultElement = document.getElementById('targetResult');
            resultElement.innerHTML = "Processing...";
    
            try {
                const response = await fetch(`/get-target/${gameCode}/${playerName}/?player-code=${playerCode}`);
                const data = await response.json();
                if (data.error) {
                    resultElement.innerHTML = data.error;
                    return;
                }
    
                resultElement.innerHTML = `Your target is: ${data.target},\nMethod: ${data.method}`;
            } catch (error) {
                resultElement.innerHTML = "An error occurred: " + error.message;
            }
        }
    </script>
</body>
</html>
